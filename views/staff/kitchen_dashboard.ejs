<%# views/staff/kitchen_dashboard.ejs %>

    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
        <link rel="stylesheet" href="/kitchen/css/dashboard.css">

        <title>
            <%= title %>
        </title>
        <%# Dynamic Title %>

            <%# NOTE: Ensure your style.css includes all necessary styles: %>
                <%# AdminHub base, .box-info, .table-data, .order, .todo, table styles, %>
                    <%# status badges, alert messages, form styles (if any forms added later), %>
                        <%# .tr-near-expiry, .tr-expired (for inventory page, may not be needed here directly) %>

    </head>

    <body>

        <section id="sidebar">
            <a href="/kitchen/dashboard" class="brand">
                <i class='bx bxs-store-alt'></i>
                <%# Kitchen Icon %>
                    <%# Display username in brand? Ensure 'user' object is passed %>
                        <span class="text"><%= user ? user.username : 'Kitchen Hub' %></span>
            </a>
            <%# Sidebar links relevant to Kitchen staff %>
                <ul class="side-menu top">
                    <li class="active">
                        <%# Active class for this page %>
                            <a href="/kitchen/dashboard">
                                <i class='bx bxs-dashboard'></i>
                                <span class="text">Dashboard</span>
                            </a>
                    </li>
                    <li>
                        <a href="/kitchen/waste/log">
                            <i class='bx bxs-trash-alt'></i>
                            <span class="text">Log Kitchen Waste</span>
                        </a>
                    </li>
                    <li>
                        <a href="/kitchen/waste/audit">
                            <i class='bx bxs-doughnut-chart'></i>
                            <span class="text">Waste Audit Summary</span>
                        </a>
                    </li>
                    <li>
                        <a href="/kitchen/inventory">
                            <i class='bx bxs-package'></i>
                            <span class="text">Manage Inventory</span>
                        </a>
                    </li>
                    <!-- <li>
                        <a href="/kitchen/inventory/add">
                            <i class='bx bx-plus-circle'></i>
                            <span class="text">Add Inventory Item</span>
                        </a>
                    </li> -->
                    <li>
                        <a href="/kitchen/guides/segregation">
                            <i class='bx bx-recycle'></i>
                            <span class="text">Waste Segregation Guide</span>
                        </a>
                    </li>
                    <li>
                        <a href="/kitchen/guides/composting">
                            <i class='bx bxs-leaf'></i>
                            <span class="text">Composting Guide</span>
                        </a>
                    </li>
                    <li>
                        <a href="/kitchen/recipes/scraps">
                            <i class='bx bx-food-menu'></i>
                            <span class="text">Food Scrap Recipes</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://sustainablekitchenconsultants.com/sustainability-training/">
                            <i class='bx bxs-book-reader'></i>
                            <span class="text">View Training Materials</span>
                        </a>
                    </li>
                </ul>
                <ul class="side-menu">
                    <li>
                        <a href="#"></a>
                    </li>
                    <%# Settings Placeholder %>
                        <li><a href="/logout" class="logout"><i class='bx bxs-log-out-circle'></i><span class="text">Logout</span></a></li>
                </ul>
        </section>
        <section id="content">
            <nav>
                <i class='bx bx-menu'></i>
                <a href="#" class="nav-link">Kitchen Area</a>
                <form action="#">
                    <div class="form-input">
                        <input type="search" placeholder="Search...">
                        <button type="submit" class="search-btn"><i class='bx bx-search'></i></button>
                    </div>
                </form>
                <input type="checkbox" id="switch-mode" hidden>
                <label for="switch-mode" class="switch-mode"></label>
                <a href="#" class="notification"><i class='bx bxs-bell'></i><span class="num">0</span></a>
                <a href="#" class="profile">
                    <span style="padding-right: 10px; vertical-align: middle;"><%= user ? user.username : 'User' %></span>
                    <i class='bx bxs-user-circle' style="font-size: 36px; vertical-align: middle;"></i>
                </a>
            </nav>
            <main>
                <div class="head-title">
                    <div class="left">
                        <h1>
                            <%= title %>
                        </h1>
                        <ul class="breadcrumb">
                            <li><a href="#">Staff Area</a></li>
                            <li><i class='bx bx-chevron-right'></i></li>
                            <li><a class="active" href="/kitchen/dashboard">Kitchen</a></li>
                        </ul>
                    </div>
                    <%# Optional Download Button %>
                </div>

                <%# Display Status Messages (if redirected here with query params) %>
                    <% if (locals.logStatus === 'success' && locals.message) { %>
                        <div class="alert alert-success">
                            <%= locals.message %>
                        </div>
                        <% } else if (locals.logStatus === 'error' && locals.message) { %>
                            <div class="alert alert-error">Error:
                                <%= locals.message %>
                            </div>
                            <% } %>
                                <%# --- End Status Messages --- %>


                                    <%# --- Repurposed Box Info Stats --- %>
                                        <%
                let totalWeeklyWaste = 0;
                let topWasteType = 'N/A';
                let topWasteAmount = 0;
                if (wasteSummaryData && wasteSummaryData.length > 0) {
                     wasteSummaryData.forEach(item => { totalWeeklyWaste += item.total_quantity; });
                     // Assuming sorted by total_quantity DESC from query
                     topWasteType = wasteSummaryData[0].waste_type.replace('_', ' '); // Format type name
                     topWasteAmount = wasteSummaryData[0].total_quantity.toFixed(2) + ' ' + wasteSummaryData[0].unit; // Format amount
                }
             %>
                                            <ul class="box-info">
                                                <li>
                                                    <i class='bx bxs-trash'></i>
                                                    <span class="text">
                         <%# Display total waste calculated from summary data %>
                        <h3><%= totalWeeklyWaste.toFixed(2) %> <small>(Units vary)</small></h3>
                        <p>Total Waste Logged (7 Days)</p>
                    </span>
                                                </li>
                                                <li>
                                                    <i class='bx bxs-badge-dollar'></i>
                                                    <%# Example icon for top waste %>
                                                        <span class="text">
                        <h3><%= topWasteType %></h3>
                        <p>Top Waste Type (<%= topWasteAmount %>)</p> <%# Show amount %>
                    </span>
                                                </li>
                                                <li>
                                                    <i class='bx bxs-error-alt'></i>
                                                    <%# Icon for low stock alert %>
                                                        <span class="text">
                         <%# Display count of low stock items %>
                        <h3><%= lowStockItems ? lowStockItems.length : 0 %></h3>
                        <p>Items Low on Stock</p>
                    </span>
                                                </li>
                                            </ul>
                                            <%# --- End Box Info Stats --- %>


                                                <%# --- Main Data Sections --- %>
                                                    <div class="table-data">

                                                        <%# Inventory Nearing Expiry (Existing) %>
                                                            <div class="order">
                                                                <div class="head">
                                                                    <h3>Inventory Nearing Expiry</h3>
                                                                    <a href="/kitchen/inventory" title="View Full Inventory"><i class='bx bx-link-external'></i></a>
                                                                </div>
                                                                <% if (nearExpiryItems && nearExpiryItems.length > 0) { %>
                                                                    <table>
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Item Name</th>
                                                                                <th>Qty</th>
                                                                                <th>Expires</th>
                                                                                <th>Action</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            <% nearExpiryItems.forEach(item => { %>
                                                                                <tr>
                                                                                    <td>
                                                                                        <p>
                                                                                            <%= item.item_name %>
                                                                                        </p>
                                                                                    </td>
                                                                                    <td>
                                                                                        <%= item.quantity %>
                                                                                            <%= item.unit %>
                                                                                    </td>
                                                                                    <td>
                                                                                        <%
                                        let expiryClass = '';
                                        let expiryText = '';
                                        const today = new Date(); today.setHours(0,0,0,0);
                                        const expiry = new Date(item.expiry_date);
                                        const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                                        if (diffDays < 0) { expiryClass = 'danger'; expiryText = 'Expired!';}
                                        else if (diffDays <= 3) { expiryClass = 'pending'; expiryText = `in ${diffDays}d`;}
                                        else { expiryText = new Date(item.expiry_date).toLocaleDateString(); }
                                    %>
                                                                                            <span class="status <%= expiryClass %>"><%= expiryText %></span>
                                                                                    </td>
                                                                                    <td><a href="/kitchen/inventory#item-<%= item.id %>" class="status completed" style="padding: 6px 10px;">View</a></td>
                                                                                </tr>
                                                                                <% }); %>
                                                                        </tbody>
                                                                    </table>
                                                                    <% } else { %>
                                                                        <p style="text-align: center; padding: 20px 0;">No items nearing expiry found.</p>
                                                                        <% } %>
                                                            </div>
                                                            <%# End Inventory Nearing Expiry %>

                                                                <%# Recent Waste Logs (New) %>
                                                                    <div class="order">
                                                                        <div class="head">
                                                                            <h3>Recent Waste Logs</h3>
                                                                            <a href="/kitchen/waste/audit" title="View Waste Audit"><i class='bx bx-link-external'></i></a>
                                                                        </div>
                                                                        <% if (recentWasteLogs && recentWasteLogs.length > 0) { %>
                                                                            <table>
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th>Time</th>
                                                                                        <th>Type</th>
                                                                                        <th>Item</th>
                                                                                        <th>Qty</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    <% recentWasteLogs.forEach(log => { %>
                                                                                        <tr>
                                                                                            <td><small><%= new Date(log.log_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></small></td>
                                                                                            <td>
                                                                                                <%= log.waste_type.replace('_',' ') %>
                                                                                            </td>
                                                                                            <td>
                                                                                                <%= log.food_item || '-' %>
                                                                                            </td>
                                                                                            <td>
                                                                                                <%= log.quantity %>
                                                                                                    <%= log.unit %>
                                                                                            </td>
                                                                                        </tr>
                                                                                        <% }); %>
                                                                                </tbody>
                                                                            </table>
                                                                            <% } else { %>
                                                                                <p style="text-align: center; padding: 20px 0;">No recent waste logs found.</p>
                                                                                <% } %>
                                                                    </div>
                                                                    <%# End Recent Waste Logs %>

                                                    </div>
                                                    <%# End First Row of table-data %>

                                                        <div class="table-data">
                                                            <%# Start Second Row %>

                                                                <%# Low Stock Items (New) %>
                                                                    <div class="todo">
                                                                        <%# Using todo style for list view %>
                                                                            <div class="head">
                                                                                <h3>Low Stock Items</h3>
                                                                                <a href="/kitchen/inventory" title="View Full Inventory"><i class='bx bx-link-external'></i></a>
                                                                            </div>
                                                                            <% if (lowStockItems && lowStockItems.length > 0) { %>
                                                                                <ul class="todo-list">
                                                                                    <% lowStockItems.forEach(item => { %>
                                                                                        <%# Add appropriate class e.g., not-completed for visual cue %>
                                                                                            <li class="not-completed">
                                                                                                <p>
                                                                                                    <%= item.item_name %> (
                                                                                                        <%= item.quantity %> /
                                                                                                            <%= item.reorder_level %>
                                                                                                                <%= item.unit %>)</p>
                                                                                                <a href="/kitchen/inventory#item-<%= item.id %>" title="View Item"><i class='bx bx-dots-vertical-rounded'></i></a>
                                                                                            </li>
                                                                                            <% }); %>
                                                                                </ul>
                                                                                <% } else { %>
                                                                                    <p style="text-align: center; padding: 20px 0;">No items below reorder level.</p>
                                                                                    <% } %>
                                                                    </div>
                                                                    <%# End Low Stock Items %>


                                                                        <%# Weekly Waste Summary (New) %>
                                                                            <div class="todo">
                                                                                <%# Using todo style %>
                                                                                    <div class="head">
                                                                                        <h3>Waste Summary (Last 7 Days)</h3>
                                                                                        <a href="/kitchen/waste/audit" title="View Waste Audit"><i class='bx bx-link-external'></i></a>
                                                                                    </div>
                                                                                    <% if (wasteSummaryData && wasteSummaryData.length > 0) { %>
                                                                                        <ul class="todo-list">
                                                                                            <% wasteSummaryData.forEach(summary => { %>
                                                                                                <li class="completed">
                                                                                                    <%# Example class %>
                                                                                                        <p><strong><%= summary.waste_type.replace('_',' ') %>:</strong>
                                                                                                            <%= summary.total_quantity.toFixed(2) %>
                                                                                                                <%= summary.unit %>
                                                                                                        </p>
                                                                                                        <%# Maybe add a small bar chart / indicator here later %>
                                                                                                </li>
                                                                                                <% }); %>
                                                                                        </ul>
                                                                                        <% } else { %>
                                                                                            <p style="text-align: center; padding: 20px 0;">No waste logged in the last 7 days.</p>
                                                                                            <% } %>
                                                                            </div>
                                                                            <%# End Weekly Waste Summary %>

                                                                                <%# Waste Collection Schedule (Existing) %>
                                                                                    <div class="todo">
                                                                                        <div class="head">
                                                                                            <h3>Waste Collection Schedule</h3>
                                                                                            <%# Add link to manage schedule if applicable %>
                                                                                        </div>
                                                                                        <ul class="todo-list">
                                                                                            <% if (collectionSchedules && collectionSchedules.length > 0) { %>
                                                                                                <% collectionSchedules.forEach(schedule => { %>
                                                                                                    <%# Determine if collection is 'completed' based on next_collection_due? Complex logic. %>
                                                                                                        <%# Defaulting to 'completed' style for now %>
                                                                                                            <li class="completed">
                                                                                                                <p>
                                                                                                                    <strong><%= schedule.waste_type.replace('_',' ') %>:</strong>
                                                                                                                    <%= schedule.collection_day %>
                                                                                                                        <% if (schedule.collection_time) { %> at
                                                                                                                            <%= schedule.collection_time %>
                                                                                                                                <% } %>
                                                                                                                                    <% if (schedule.next_collection_due) { %> <br><small>(Next Due: ~<%= new Date(schedule.next_collection_due).toLocaleDateString() %>)</small>
                                                                                                                                        <% } %>
                                                                                                                </p>
                                                                                                                <i class='bx bx-dots-vertical-rounded'></i>
                                                                                                            </li>
                                                                                                            <% }); %>
                                                                                                                <% } else { %>
                                                                                                                    <p style="text-align: center; padding: 20px 0;">No collection schedules defined.</p>
                                                                                                                    <% } %>
                                                                                        </ul>
                                                                                    </div>
                                                                                    <%# End Waste Collection Schedule %>

                                                        </div>
                                                        <%# End Second Row of table-data %>
                                                            <%# --- End Main Data Sections --- %>

            </main>
        </section>
        <script src="/kitchen/js/dashboard.js"></script>
    </body>

    </html>